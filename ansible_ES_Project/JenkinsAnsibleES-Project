// Variable for input
def userInput

pipeline 
{
	agent
	{
		label 'master'
	}
	stages
	{
		stage('Checkout')
		{
			steps
			{
				dir('Course')
				{
					script
					{
						git credentialsId: 'DevOpsINT', url: 'https://github.com/DevOpsINT/Course.git' , branch: 'gadi'
						sh 'ls'
					}
				}
			}
		}
		stage('Interactive_Input')
		{
			steps
			{
				script
				{
					// Get the input
					userInput = input (id: 'userInput', message: 'Please Enter Remote Machine IP:',
								parameters: 
								[
									string
									(
										defaultValue: '35.160.199.228',
										description: 'IP of the machine to procced the pipeline connabds',
										name: 'IP'
									),
								]
							  )

					// Echo to console
					echo("Entered IP Is: ${userInput}")
		    	}
			}
		}
		stage('Save Input Value Into Hosts File')
		{
			steps
			{
				dir('ansible_ES_Project')
				{
					script
					{
						//Save userInput value
						sh "pwd"
						sh "ls"
						sh "echo $userInput >> hosts"
						sh "cat hosts"
						sh "pwd"
					}
				}
			}
		}
		stage('Choose Requested Module And Version From Dir List (ls)')
		{
			steps
			{
				dir('ansible_ES_Project')
				{
					script
					{
						//Read AvailibleModules File
						_ModulesList = sh script: 'ls roles', returnStdout: true
						println(_ModulesList)

						//Choices parameter
						_ChoosenModule = input message: 'Please choose which module to install from the list below',
						ok: 'Confirm',
						parameters: [choice(name: '', choices: "${_ModulesList}", description: '')]
						_ChoosenModuleName = cut -d':' -f1 <<< _ChoosenModule
						_ChoosenModuleVer = cut -d':' -f2 <<< _ChoosenModule
						println(_ChoosenModuleName)
						println(_ChoosenModuleVer)
					}
				}
			}
		}
		stage('Run Ansible Pipeline')
		{
			steps
			{
				dir('ansible_ES_Project')
				{
					script
					{
						//Run Ansible Playbook
						sh "pwd"
						sh "ls"
						sh "which ansible"
						sh "ps axufwwww | grep 'jenkins | java' - "
						sh "cat /var/jenkins_home/.ssh/AWS_Key_Instance1.pem"

						//Install Selected Modul${_ChoosenModuleName}e
						sh "ansible-playbook -vvvv -u ubuntu -i hosts -b --private-key=/var/jenkins_home/.ssh/AWS_Key_Instance1.pem -e hosts=${userInput} -e ModuleName=${_ChoosenModuleName} -e _SelectedVersion=${_ChoosenModuleVer}  main.yml"
					}
				}
			}
		}
/*		stage('push new file')
		{
        steps
			{
				dir('Course')
				{
                    script
					{
                        withCredentials([usernamePassword(credentialsId: 'DevOpsINT', passwordVariable: 'Password', usernameVariable: 'Username')])
						{
							sh('pwd')
							sh('git status')
							sh('git config --global user.name "Gadi"')
							sh('git config --global user.email "gadigamburg@gmail.com"')
							sh('git checkout gadi')
							sh('git pull')
							sh('echo testing > ifconfig.file')
							sh('git add .')
							sh('git commit -m "Auto Push Pipeline gadi_file"')
                            sh('git status')
							sh('git push https://${Username}:${Password}@github.com/DevOpsINT/Course.git gadi')
						}
                    }
				}
			}
		}*/
	}
}

